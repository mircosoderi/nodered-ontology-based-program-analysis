#!/usr/bin/env python3
"""Generate scaled Node-RED flows JSON by duplicating each 'tab' and its nodes.

It rewrites IDs consistently and updates internal references (wires, links, groups, etc.)
by replacing any string value that exactly matches an old id with the new id.

Usage:
  python3 make_scaled_flows.py --in nodered-default-flows.json --outdir ./scaled --factors 1,5,10,20
"""
import argparse, json, os
from copy import deepcopy
from typing import Any, Dict, List

def replace_ids(obj: Any, idmap: Dict[str,str]) -> Any:
    if isinstance(obj, str):
        return idmap.get(obj, obj)
    if isinstance(obj, list):
        return [replace_ids(x, idmap) for x in obj]
    if isinstance(obj, dict):
        return {k: replace_ids(v, idmap) for k,v in obj.items()}
    return obj

def main() -> int:
    ap=argparse.ArgumentParser()
    ap.add_argument('--in', dest='infile', required=True)
    ap.add_argument('--outdir', required=True)
    ap.add_argument('--factors', required=True)
    ap.add_argument('--suffix', default='')
    args=ap.parse_args()

    with open(args.infile,'r',encoding='utf-8') as f:
        data=json.load(f)
    if not isinstance(data, list):
        raise SystemExit('Input flows must be a JSON array')

    tabs=[o for o in data if isinstance(o,dict) and o.get('type')=='tab' and isinstance(o.get('id'),str)]
    tab_ids=[t['id'] for t in tabs]

    by_tab={tid:[] for tid in tab_ids}
    others=[]
    for o in data:
        if not isinstance(o,dict): 
            continue
        if o.get('type')=='tab':
            continue
        z=o.get('z')
        if isinstance(z,str) and z in by_tab:
            by_tab[z].append(o)
        else:
            others.append(o)

    os.makedirs(args.outdir, exist_ok=True)
    factors=[int(x.strip()) for x in args.factors.split(',') if x.strip()]
    base=os.path.splitext(os.path.basename(args.infile))[0]

    for factor in factors:
        if factor < 1:
            raise SystemExit('Factors must be >= 1')

        out=[]
        out.extend(deepcopy(others))
        out.extend(deepcopy(tabs))
        for tid in tab_ids:
            out.extend(deepcopy(by_tab[tid]))

        for k in range(2, factor+1):
            idmap={}
            batch=[]
            for tab in tabs:
                batch.append(deepcopy(tab))
                batch.extend(deepcopy(by_tab[tab['id']]))

            for o in batch:
                oid=o.get('id')
                if isinstance(oid,str):
                    idmap[oid]=f"{oid}_{k}"

            batch=[replace_ids(o, idmap) for o in batch]
            out.extend(batch)

        suf=args.suffix or ''
        outname=f"{base}.x{factor}{suf}.json"
        outpath=os.path.join(args.outdir,outname)
        with open(outpath,'w',encoding='utf-8') as f:
            json.dump(out,f,ensure_ascii=False,indent=2)
        print(outpath)
    return 0

if __name__=='__main__':
    raise SystemExit(main())
